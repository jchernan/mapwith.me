var Hosts={};Hosts.addressFind="http://www.mapwith.me/map_find",Hosts.venuesFind="http://www.mapwith.me/venue_find",Hosts.collaboration="http://www.mapwith.me:8000",Hosts.baseURL="http://www.mapwith.me",Hosts.tiles="http://www.mapwith.me:8888/v2/maps/{z}/{x}/{y}.png";var SanFrancisco={center:{latitude:37.7785,longitude:-122.4192},upperLeft:{latitude:38.4948,longitude:-123.2128},lowerRight:{latitude:37.1716,longitude:-121.5401}},Boston={center:{latitude:42.3605,longitude:-71.0593},upperLeft:{latitude:42.702,longitude:-71.861},lowerRight:{latitude:41.951,longitude:-70.285}},Cities={"san-francisco":SanFrancisco,boston:Boston},DefaultCity="san-francisco",MapApp={useLeaflet:!1};MapApp.content=function(){var e='<div class="row-fluid"><div class="span12"><div class="span6"><p>Type your name and then click <strong>Start</strong>. This will create a link that you can share with your friends.</p></div><div class="span6"><form id="popover-form"><div class="input-append"><input id="popover-form-input" class="input-medium" type="text" placeholder="Type your name"><button id="popover-form-button" class="btn" type="submit">Start</button></div></form></div></div></div>',n="Share what you are viewing!",t='<div id="session-link"><code>LINK</code></div>',o="You are now sharing this map!",a='<div class="modal fade hide" id="initial-modal" style="width:350px"><div class="modal-header"><button type="button" class="close" data-dismiss="modal">x</button><h3> Your friend wants to map with you</h3></div><div class="modal-body" ><div><p>Type your name and then click <strong>Join</strong> to start sharing.</p> </div><form id="modal-form"><center><input id="modal-form-input" class="input-large" type="text" placeholder="Type your name"></center></form></div><div class="modal-footer"><a href="#" class="btn" data-dismiss="modal">Close</a><a href="#" class="btn btn-primary" id="join-modal">Join</a></div></div>';return{startSession:e,startSessionTitle:n,sessionLink:t,sessionLinkTitle:o,joinSession:a}}(),MapApp.log={warn:function(e){console.warn(e)},err:function(e){console.error(e)},info:function(e){console.log(e)}},MapApp.assert=function(e,n){if(!e)throw MapApp.log.err(n),new AssertException(n)};var urlParam=function(e){MapApp.log.info("Retrieving URL parameter "+e);var n=RegExp("[\\?&]"+e+"=([^&#]*)").exec(window.location.href);return n?n[1]:null},isSameCenter=function(e,n){return 1e-4>Math.abs(e.latitude-n.latitude)&&1e-4>Math.abs(n.longitude-n.longitude)};MapApp.collab=function(){function e(e,n){MapApp.log.info("[change_state] Emitting center: "+JSON.stringify(e)+" and zoom: "+n);var t=r("change_state");l("change_state",t,{center:e,zoom:n})}function n(e){MapApp.log.info("[message] Emitting message: "+e),t.emit("send_message",{message:e})}var t,o,a=0,i={opType:null,xid:null},p={opType:null,data:null},r=function(e,n){if(p.opType===e)switch(e){case"change_zoom":if(p.data.zoom===n.zoom)return p={opType:null,data:null},-1;break;case"change_center":if(isSameCenter(p.data.center,n.center))return p={opType:null,data:null},-1}return i.opType=e,i.xid=++a,i.xid},s=function(e,n){return i.opType===n?(e.xid===i.xid&&(i={opType:null,xid:null}),!1):(p.opType=n,p.data=e,!0)},l=function(e,n,o){o.xid=n,t.emit(e,o)},c=function(){MapApp.assert(t,"Socket must be initialized");var e=function(e,n){t.on(e,function(t){s(t,e)?n(t):MapApp.log.info("["+e+"] Filtered message due to "+"pending state. Message was: "+JSON.stringify(t))})};t.on("search",function(e){MapApp.log.info("[search] Received "+JSON.stringify(e)),MapApp.collab.trigger("search",e)}),e("change_center",function(e){MapApp.log.info("[change_center] Received "+JSON.stringify(e)),MapApp.collab.trigger("change_center",e)}),e("change_zoom",function(e){MapApp.log.info("[change_zoom] Received "+JSON.stringify(e)),MapApp.collab.trigger("change_zoom",e)}),e("change_state",function(e){MapApp.log.info("[change_state] Received "+JSON.stringify(e)),MapApp.collab.trigger("change_state",e)}),e("send_message",function(e){MapApp.log.info("[send_message] Received "+JSON.stringify(e)),MapApp.collab.trigger("send_message",e)}),e("add_user",function(e){MapApp.log.info("[add_user] Received "+JSON.stringify(e)),MapApp.collab.trigger("add_user",e)}),e("init_ack",function(e){MapApp.log.info("[init_ack] Received initialize ack for collab session: "+JSON.stringify(e)),o=e.cid,MapApp.collab.trigger("init_ack",e),MapApp.collab.trigger("change_state",{center:{latitude:e.state.center.latitude,longitude:e.state.center.longitude},zoom:e.state.zoom})}),e("error",function(e){console.log(e),MapApp.log.err(JSON.stringify(e))})},d=function(e){MapApp.log.info("[search] Emitting address: "+e);var n=r("search");l("search",n,{address:e})},u=function(e){MapApp.log.info("[init] Emitting init: "+JSON.stringify(e));var n=r("init");l("init",n,e)},g=function(){MapApp.log.info("[start-session] User is starting share session");var e={center:MapApp.map.getCenter(),zoom:MapApp.map.getZoom(),username:$("#popover-form-input").val()};return u(e),!1},m=function(){MapApp.log.info("[join-session] User is joining share session");var e={session_id:urlParam("session_id"),username:$("#modal-form-input").val()};return u(e),!1},f=function(e){var n={center:e},t=r("change_center",n);t>0&&(MapApp.log.info("[change_center] Emitting center: "+JSON.stringify(e)),l("change_center",t,n))},h=function(e){var n={zoom:e},t=r("change_zoom",n);t>0&&(MapApp.log.info("[change_zoom] Emitting zoom: "+e),l("change_zoom",t,n))};return t=io.connect(Hosts.collaboration),c(),{startSession:g,joinSession:m,sendSearch:d,sendChangeCenter:f,sendChangeZoom:h,sendChangeState:e,sendMessage:n}}(),_.extend(MapApp.collab,Backbone.Events),MapApp.chatWindow=function(){var e="icon-eye-open",n=function(e,n){$("#chat-panel-rows .message:last").after('<div class="message"><span class="sender">'+e+"</span>"+n+"</div>"),$("#chat-panel-rows").each(function(){var e=Math.max(this.scrollHeight,this.clientHeight);this.scrollTop=e-this.clientHeight})},t=function(n){var t="icon_"+n,a="user_list_elem_"+n;$("#user_list li:last").after("<li id='"+a+"'>"+"<i id='"+t+"' class='"+e+"'></i>"+n+"</li>"),o(n);var i=$("#user_list li").length-2,p=i>1?" friends":" friend";i>0?$("#user_list_title").text("Sharing with "+i+p+": "):$("#user_list_title").text("No friends have joined")},o=function(n){var t="icon_"+n;$("#"+t).attr("class",e)},a=function(e,o){var a=13,i=function(){var t=$.trim($("#chat_text").val());return""!==t&&(n("Me",t),e&&e(t)),$("#chat_text").val(""),!1};if($("#chat_button").click(i),$("#chat_text").keydown(function(e){return e.keyCode===a?(i(),!1):void 0}),t("Me"),o!==void 0)for(var p=0;o.length>p;p++)t(o[p]);$("#right_bar").css("display",""),MapApp.collab.on("send_message",function(e){n(e.from,e.message)}),MapApp.collab.on("add_user",function(e){t(e.username)})};MapApp.collab.on("init_ack",function(e){a(function(e){MapApp.collab.sendMessage(e)},e.state.usernames)})}(),MapApp.map=function(){var e,n=Cities,t=DefaultCity,o={min:11,max:18,defaultZoom:13,foundZoom:15},a=new L.LayerGroup,i={initialize:function(){$("#map").addClass("map-leaflet");var i=n[t].center;e=new L.Map("map",{center:new L.LatLng(i.latitude,i.longitude),zoom:o.defaultZoom,inertia:!1});var p=new L.TileLayer(Hosts.tiles,{maxZoom:o.max,minZoom:o.min});e.addLayer(a),e.addLayer(p),e.attributionControl.setPrefix('Powered by <a href="http://leaflet.cloudmade.com">Leaflet</a>, <a href="http://foursquare.com">Foursquare</a>, and <a href="http://www.google.com">Google</a>'),e.attributionControl.addAttribution('Map Data &copy; <a href="http://www.openstreetmap.org">OpenStreetMap</a>'),e.on("zoomend",function(){MapApp.map.clearMarkers(),f(c),h(d)})},setCenter:function(n){e.panTo(new L.LatLng(n.latitude,n.longitude),!0)},setZoom:function(n){e.setZoom(n,!0)},setView:function(n,t,o){e.setView(new L.LatLng(n.latitude,n.longitude),t,!1,o)},getCenter:function(){var n=e.getCenter();return{latitude:n.lat,longitude:n.lng}},getZoom:function(){return e.getZoom()},getCorner:function(){var n=e.getBounds().getNorthWest();return{latitude:n.lat,longitude:n.lng}},inBounds:function(e){for(var t in n)if(n.hasOwnProperty(t)){var o=n[t];if(e.latitude>=o.lowerRight.latitude&&e.latitude<=o.upperLeft.latitude&&e.longitude>=o.upperLeft.longitude&&e.longitude<=o.lowerRight.longitude)return!0}return!1},addMarker:function(e,n,t){var o=new L.LatLng(e.latitude,e.longitude),i=n,p=new L.Marker(o,{icon:i});if(t!==void 0){var r=null;t.icon&&(r=t.icon.prefix+"32.png"),p.bindPopup(s(r,t.name,t.stars,t.address)).openPopup()}return a.addLayer(p),o},clearMarkers:function(){a.clearLayers()},geopointImage:L.icon({iconUrl:"images/markers/pink-pin.png",shadowUrl:null,iconSize:new L.Point(16,28),iconAnchor:new L.Point(8,28),popupAnchor:new L.Point(0,-28)}),venueImage:L.icon({iconUrl:"images/markers/blue-pin.png",shadowUrl:null,iconSize:new L.Point(16,28),iconAnchor:new L.Point(8,28),popupAnchor:new L.Point(0,-28)}),enableCollabListeners:function(){e.on("dragend",A),e.on("collabend",b)}},p={initialize:function(){$("#map").addClass("map-google");var a=n[t].center,i={center:new google.maps.LatLng(a.latitude,a.longitude),zoom:o.defaultZoom,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:!0,mapTypeControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT,mapTypeIds:[google.maps.MapTypeId.ROADMAP,google.maps.MapTypeId.HYBRID,google.maps.MapTypeId.SATELLITE]},rotateControl:!1,streetViewControl:!1,tilt:0};e=new google.maps.Map(document.getElementById("map"),i),google.maps.event.addListener(e,"zoom_changed",function(){MapApp.map.clearMarkers(),f(c),h(d)})},setCenter:function(n){var t=MapApp.map.getCenter();isSameCenter(t,n)||e.panTo(new google.maps.LatLng(n.latitude,n.longitude))},setZoom:function(n){var t=MapApp.map.getZoom();t!==n&&e.setZoom(n)},setView:function(e,n){MapApp.map.setCenter(e),MapApp.map.setZoom(n)},getCenter:function(){var n=e.getCenter();return{latitude:n.lat(),longitude:n.lng()}},getZoom:function(){return e.getZoom()},getCorner:function(){var n=e.getBounds().getNorthEast();return{latitude:n.lat(),longitude:n.lng()}},inBounds:function(){return!0},addMarker:function(n,t,o){var a=new google.maps.LatLng(n.latitude,n.longitude),i=new google.maps.Marker({position:a,icon:t,map:e});if(o!==void 0){var p=null;o.icon&&(p=o.icon.prefix+"32.png");var r=new google.maps.InfoWindow({content:s(p,o.name,o.stars,o.address)});google.maps.event.addListener(i,"click",function(){r.open(e,i)})}return l.push(i),a},clearMarkers:function(){if(l){for(var e in l)l[e].setMap(null);l.length=0}},geopointImage:new google.maps.MarkerImage("images/markers/pink-pin.png",new google.maps.Size(16,28),new google.maps.Point(0,0),new google.maps.Point(8,28)),venueImage:new google.maps.MarkerImage("images/markers/blue-pin.png",new google.maps.Size(16,28),new google.maps.Point(0,0),new google.maps.Point(8,28)),enableCollabListeners:function(){google.maps.event.addListener(e,"zoom_changed",w),google.maps.event.addListener(e,"center_changed",A)}},r=function(e){var t=n[e].center;MapApp.map.setView(t,o.defaultZoom)},s=function(e,n,t,o){var a=function(e){for(var n="",t=0;5>t;t++)n+=e>t?"<span class='red-star'></span>":"<span class='gray-star'></span>";return n},i='<div style="overflow:auto;width:100%" >';return i+='<div class="venue-icon"> ',e&&(i+='<img class="venue-icon" src="'+e+'" />'),i+="</div>",i+='<div class="venue-main"> ',i+='<div style="font-weight:bold">'+n+"</div>",i+='<div style="height:16px">'+a(t)+"</div>",i+="</div>",i+="</div>",o&&(i+='<div class="venue-address">'+o+"</div>"),i},l=[],c=[],d=[],u=function(){c=[],d=[],MapApp.map.clearMarkers()},g=function(e){c=c.concat(e),f(e)},m=function(e){d=d.concat(e),h(e)},f=function(e){if(0!==e.length){MapApp.log.info("Call to renderGeopoints. Received "+e.length+" points.");for(var n=0;e.length>n;n++)MapApp.map.addMarker(e[n],MapApp.map.geopointImage)}},h=function(e){if(0!==e.length){MapApp.log.info("Call to renderVenues. Received "+e.length+" points."),e=e.slice(0);var n=MapApp.map.getZoom(),t=MapApp.map.getCenter(),o=MapApp.map.getCorner(),a=M(t,o),i=.002*a;MapApp.log.info("zoom level: "+n+", thresh radius: "+i);for(var p=!0,r=0;p;){p=!1;for(var s=0;e.length>s;s++){var l,c=e[s],d=v(c,e),u=e[d];l=u.popularity<c.popularity?d:s,i>M(u,c)&&(e.splice(l,1),p=!0,r+=1)}}MapApp.log.info("Spliced "+r+" venues"),MapApp.log.info("Rendering "+e.length+" venues");for(var g=0;e.length>g;g++){var m=e[g];MapApp.map.inBounds(m)&&MapApp.map.addMarker(m,MapApp.map.venueImage,m)}}},v=function(e,n){for(var t=$.map(n,function(n){return n===e?Number.MAX_VALUE:M(n,e)}),o=Number.MAX_VALUE,a=0,i=0;n.length>i;i++)o>t[i]&&(a=i,o=t[i]);return a},M=function(e,n){return Math.pow(e.latitude-n.latitude,2)+Math.pow(e.longitude-n.longitude,2)},A=function(){var e=MapApp.map.getCenter();MapApp.collab.sendChangeCenter(e)},w=function(){var e=MapApp.map.getZoom();MapApp.collab.sendChangeZoom(e)},b=function(){var e=MapApp.map.getCenter(),n=MapApp.map.getZoom();MapApp.collab.sendChangeState(e,n)};MapApp.collab.on("change_center",function(e){MapApp.log.info("[change_center] Setting new center: "+JSON.stringify(e.center)),MapApp.map.setCenter(e.center)}),MapApp.collab.on("change_zoom",function(e){MapApp.log.info("[change_zoom] Setting new zoom: "+e.zoom),MapApp.map.setZoom(e.zoom)}),MapApp.collab.on("change_state",function(e){MapApp.log.info("[change_state] Setting new state with center: "+JSON.stringify(e.center)+" and zoom: "+e.zoom),MapApp.map.setView(e.center,e.zoom,!0)}),MapApp.collab.on("init_ack",function(){MapApp.map.enableCollabListeners()});var y={defaultArea:t,mapZooms:o,setViewOnArea:r,clear:u,drawGeopoints:g,drawVenues:m};for(var _ in i)MapApp.useLeaflet&&i.hasOwnProperty(_)?y[_]=i[_]:p.hasOwnProperty(_)&&(y[_]=p[_]);return y}(),MapApp.useLeaflet?window.addEventListener("load",MapApp.map.initialize):google.maps.event.addDomListener(window,"load",MapApp.map.initialize),MapApp.searchField=function(){var e="#address-input",n="images/loader.gif",t=function(){return $(e).val()},o=function(){$(e).css("background-image",'url("'+n+'")')},a=function(){$(e).css("background-image","")};return{showLoader:o,hideLoader:a,getInput:t}}(),MapApp.search=function(){var e=function(){var e=MapApp.searchField.getInput();return!e||/^\s*$/.test(e)?(MapApp.log.warn("Undefined or empty input"),!1):(MapApp.collab.sendSearch(e),!1)},n={cid:null,xid:null};return MapApp.collab.on("search",function(e){MapApp.log.info("[search] Current search is "+JSON.stringify(n));var t=e.from_cid===void 0,o=!n.cid&&!n.xid,a=e.from_cid===n.cid&&e.xid===n.xid;if(t||o||a){var i=e.type;switch(MapApp.log.info('[search] Performing search operation "'+e.type+'"'),i){case"begin":n.cid=e.from_cid,n.xid=e.xid,MapApp.searchField.showLoader(),MapApp.map.clear();break;case"end":MapApp.searchField.hideLoader(),n.cid=null,n.xid=null;break;case"draw_geopoints":e.points&&e.points.length>0&&(MapApp.map.drawGeopoints(e.points),MapApp.map.setView(e.points[0],MapApp.map.mapZooms.foundZoom));break;case"draw_venues":e.points&&e.points.length>0&&MapApp.map.drawVenues(e.points)}}}),{findAddress:e}}(),MapApp.shareButton=function(){var e="#share",n=function(){return $(e)},t=function(){n().removeClass("btn-inverse"),n().addClass("btn-success"),n().html("Sharing")};return MapApp.collab.on("init_ack",t),{getButton:n}}(),!function(e){"use strict";var n=function(e,n){this.init("sharepopover",e,n)};n.prototype=e.extend({},e.fn.popover.Constructor.prototype,{constructor:n,show:function(){var e,n,t,o,a,i,p;this.hasContent()&&this.enabled&&(e=this.tip(),this.setContent(),this.options.animation&&e.addClass("fade"),i="bottom",n=/in/.test(i),e.remove().css({top:0,left:0,display:"block"}).appendTo(n?this.$element:document.body),t=this.getPosition(n),o=e[0].offsetWidth,a=e[0].offsetHeight,p={top:t.top+t.height+3,left:t.left+t.width-o},e.css(p).addClass(i).addClass("in"))}}),e.fn.sharepopover=function(t){return this.each(function(){var o=e(this),a=o.data("sharepopover"),i="object"==typeof t&&t;a||o.data("sharepopover",a=new n(this,i)),"string"==typeof t&&a[t]()})},e.fn.sharepopover.Constructor=n,e.fn.sharepopover.defaults=e.extend({},e.fn.popover.defaults,{template:'<div class="popover"><div class="arrow" style="left:93%"></div><div class="popover-inner" style="width:500px;"><h3 class="popover-title"></h3><div class="popover-content"><p></p></div></div></div>'})}(window.jQuery),function(e){e.fn.vAlign=function(){return this.each(function(){var n=e(this).height(),t=e(this).parent().height(),o=Math.ceil((t-n)/2);e(this).css("margin-top",o)})}}(window.jQuery),MapApp.sessionInitWindow=function(){var e=MapApp.shareButton.getButton(),n=function(e){if(null===e)return MapApp.content.startSession;var n=MapApp.content.sessionLink.replace("LINK",e);return n},t=function(e){return null===e?MapApp.content.startSessionTitle:MapApp.content.sessionLinkTitle},o=function(){e.sharepopover("toggle"),$("#popover-form").length>0&&($("#popover-form").vAlign(),$("#popover-form").submit(MapApp.collab.startSession),$("#popover-form-button").click(MapApp.collab.startSession))},a=function(){e.sharepopover("hide")},i=function(o,a){var i=e.data("sharepopover");a&&(i.options.animation=!1),i.options.content=n(o),i.options.title=t(o),a&&(e.sharepopover("show"),i.options.animation=!0)};e.sharepopover({trigger:"manual",html:!0,content:n(null),title:t(null)}),window.onresize=a,e.click(o),MapApp.collab.on("init_ack",function(e){var n=Hosts.baseURL+"?session_id="+e.session_id;i(n,!0)})}(),MapApp.sessionJoinWindow=function(){var e=$(MapApp.content.joinSession),n=function(){$("body").append(e),$("#modal-form").submit(MapApp.collab.joinSession),$("#join-modal").click(MapApp.collab.joinSession),e.modal({backdrop:!0}).css({width:"auto","margin-left":function(){return-($(this).width()/2)}}),e.modal("show")};MapApp.collab.on("init_ack",function(){e.modal("hide")}),urlParam("session_id")&&n()}();